自定义View——字母索引列表

### 一、分析：

- 26个字母：在onDraw中根据每个字母的height、baseLine绘制
- 高亮选中：在onTouch中改变选中的字母，在onDraw中用另一只Paint重回被选中的字母，然后高亮
- 状态实时改变：onTouch中监听用户滑动

### 二、实现

#### 1、准备：

由效果可知，我们的View会有两种状态

- 正常显示
- 高亮

要实现这两种状态也可以有两种方案

- 使用一个Paint，每次重绘高亮代码时，给画笔换颜色
- 使用两个Paint，正常显示的字母用一个，高亮字母的用一个

但是我们设置重绘时是在onDraw方法中进行的，意味着他的调用会很频繁，如果我们每次都去调用setColor()方法，就会调用很多次，所以为了性能考虑，我们最终还是选中用两个Paint对其进行修改

#### 2、初始化

通过从自定义属性中获取一些属性值

Paint对象，和往常套路一样，给Paint对象实例化、设置防锯齿、颜色、字体大小等

#### 3、onMeasure方法

由于我们的字母索引表是竖直方向的，所以我们只需要考虑他的宽为多少即可，高就直接match_parent就行，所以我们现在来计算view的宽

宽 = 左右padding + 字母的宽

而字母的宽需要根据Paint对象来获取，由于我们在初始化的时候，设置了`Pain.setTextSize`，所以可以通过`paint.measureText("A")`来测量字母的宽度

最后调用`setMeasuredDimension(width, height);`

#### 3、onDraw方法

在绘制View的时候主要注意两点

- 如何将每个字母绘制到他的位置上：需要计算每个字母的基线来确定
- 高亮字母如何确定：设置flag，让高亮字母用另一种画笔进行绘制

在绘制之前，我们需要先获得每个字母的高度

```
每个字母的高度 = (view高度 - 上下padding) / 字母个数
```

由于每个字母的绘制流程类似，只是基线的位置不同，所以我们可以利用一个for循环搞定，而不用一个一个的去单独绘制

字母的基线不等于字母的中心位置，但是依赖于字母的中心位置，所以先计算字母的中心位置

```
第i个字母的中心位置 = (i-1) X 字母高度 + 字母高度 X 2 + view的paddingTop
```

有了中心位置，基线的计算也简单了

```
基线 = 中心位置 + (FontMetrics.bottom - FontMetrics.top) / 2 - FontMetrics.bottom
```

这样就算出了字母的基线位置，对于字母的起始位置x

```
起始位置x = (View的width - 字母的width) / 2
```

而字母的width和onMeasure()中的计算一样，都是通过paint.measureText()方法去得到

最后，我们就能调用canvas.drawText()对字母进行绘制了。

```java
//如果当前字母要高亮(这里设置两个Paint比较好一点，因为如果一直改颜色的话，会一直去调用底层C代码，影响性能)
if (mLetters[i] == mCurTouchLetter) {
    canvas.drawText(String.valueOf(mLetters[i]), x, baseLine, mSelectedPaint);
} else {
    canvas.drawText(String.valueOf(mLetters[i]), x, baseLine, mPaint);
}
```

下面我们处理高亮字母，由于高亮字母是根据用户得选择实时改变得，所以在此之前，我们得在onTouch()方法中获取需要高亮得字母

#### 4、onTouch

用户通过点击或滑动来选择高亮的字母，所以我们对用户的触摸事件进行监听

在用户手指按下或移动过程中，我们得到用户触摸的当前的Y轴坐标

```java
float curMoveY = event.getY();
```

然后用这个坐标去除以每个字母的高度，这样就能获得当前要高亮的字母，

```java
int curPosition = (int) (curMoveY / itemHeight);
```

不过，我们得设置一个防溢出措施，当用户的滑动到View的最开始的时候，position会为负数，而滑动到View最底部，position又会超出字母数组的大小，所以

```java
if (curPosition < 0) {
    curPosition = 0;
} else if (curPosition > mLetters.length - 1) {
    curPosition = mLetters.length - 1;
}
mCurTouchLetter = mLetters[curPosition];
//重新绘制
invalidate();
```

#### 5、设置监听

目前我们只是在内部自己改变高亮的字母，但是外界不知道啊，我们得提供一个方法，方便通知外界我们高亮得字母是多少，所以

```java
//其他View不会使用这个接口，所以这个只需要写在我们这个View的里面，如果两个以上的View要使用这个接口，就把这个接口写到外面去
public interface LetterTouchListener{
    void touch(String letter);
    void up();
}
```

touch是通知当前选择得字母

up是通知外界用户停止触摸事件了



